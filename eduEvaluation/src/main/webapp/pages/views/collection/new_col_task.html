<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>新建填报任务</title>
		<meta name="renderer" content="webkit">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0">
		<link rel="stylesheet" href="../../layuiadmin/layui/css/layui.css" media="all">
		<link rel="stylesheet" href="../../layuiadmin/style/admin.css" media="all">
	</head>
	<style>
	.noborder td{
	border:0;
	text-align: right;
	}
	#main-tb span{
	color:red;
	}
	</style>
	<body style="background-color:white">

		<div class="layui-fluid layui-card-body" style="border: 0;">
			<div class="layui-card-body" style="border: 0;">
				<div class="layui-form  layuiadmin-card-header-auto" lay-filter="col_task_form" style="border: 0;">
				<table class="layui-table" style="width:800px;border: 1px solid #e6e6e6;" id="main-tb">
				 <tr class="noborder">
					<td><span>*</span>专业填报任务名称：</td><td><input type="text" name="name" id="name" placeholder="请输入填报任务名称"   lay-verify="required" autocomplete="off" class="layui-input"></td>
					<td><span>*</span>填报任务所属年度：</td><td style="text-align: left;">
						<select name="year" id="year">
								   <option value="2018">2018</option>
									<option value="2019">2019</option>
									<option value="2020">2020</option>
									<option value="2021">2021</option>
									<option value="2022">2022</option>
									<option value="2023">2023</option>
									<option value="2024">2024</option>	
								</select>
					</td>
				 </tr>
				 <tr class="noborder">
				 	<td><span>*</span>开始日期：</td><td>	<input type="text" name="date" id="startDate"   lay-verify="required|date" placeholder="yyyy-MM-dd" autocomplete="off"
								 class="layui-input"></td>
				 	<td><span>*</span>结束日期：</td><td><input type="text" name="date" id="endDate" required lay-verify="required|date" placeholder="yyyy-MM-dd" autocomplete="off" class="layui-input"></td>
				 </tr>				 
				</table>
				<table class="layui-table" id="weightForm" style="table-layout:fixed; width:800px; text-align: center;">			 
					  <thead>
					    <tr >
					      <th style="text-align: center;">编号</th>
					      <th style="width:300px;text-align: center;">填报内容</th>
					      <th style="text-align: center;">权重</th>
					    </tr> 
					  </thead> 
					  <tbody>
					     <tr align="center">
					      <td align="center">1</td>
					      <td align="center">专业基本情况</td>
					      <td align="center"><input   name="weighting1" value="20"   lay-verify="required" id="weighting1"   class="layui-input layui-input-number" min="0" max="100"   data-prec="0"></td>
					    </tr>
					    <tr>
					      <td>2</td>
					      <td>绩效目标完成情况</td>
					      <td><input   name="weighting2"   value="60" lay-verify="required" id="weighting2"   class="layui-input layui-input-number" min="0" max="100" step="1" data-prec="0"></td>
					    </tr>
					    <tr>
					      <td>3</td>
					      <td>资金支出进度</td>
					      <td><input   name="weighting3" value="20"   lay-verify="required" id="weighting3"    class="layui-input layui-input-number" min="0" max="100" step="1" data-prec="0"></td>
					    </tr>
					   </tbody>
					  </table>
 
					</div>
				</div>


				 
				<div class="layui-card-body">
					<div style="padding-bottom: 10px;">
						<button class="layui-btn layuiadmin-btn-list" data-type="add"><i class="layui-icon layui-icon-add-1"></i> 为任务分配院校</button>
						<!--<button class="layui-btn layuiadmin-btn-list layui-btn-danger" data-type="batchdel"><i class="layui-icon layui-icon-delete"></i> 移除</button>-->
					</div>
					<table id="LAY-app-content-list" lay-filter="LAY-app-content-list"></table>
					<script type="text/html" id="table-content-list">
						<a class="layui-btn layui-btn-warm layui-btn-xs" lay-event="view"><svg t="1567675191751" class="icon" style="margin-top:5px;height:12px;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2377" width="15" height="15"><path d="M512.3328 206.554112c-303.401984 0-459.177984 305.772544-459.177984 305.772544s117.551104 305.814528 459.177984 305.814528c309.380096 0 459.162624-304.621568 459.162624-304.621568S820.52096 206.554112 512.3328 206.554112zM513.025024 703.459328c-110.930944 0-191.125504-83.627008-191.125504-191.133696 0-107.521024 80.19456-191.118336 191.125504-191.118336 110.926848 0 191.121408 83.596288 191.121408 191.118336C704.146432 619.83232 623.951872 703.459328 513.025024 703.459328zM513.025024 397.6448c-63.398912 0.137216-114.676736 53.246976-114.676736 114.680832 0 61.395968 51.277824 114.680832 114.676736 114.680832 63.398912 0 114.669568-53.284864 114.669568-114.680832C627.694592 450.876416 576.423936 397.522944 513.025024 397.6448z" p-id="2378" fill="#ffffff"></path></svg>查看</a>
						<a class="layui-btn layui-btn-warm layui-btn-xs" lay-event="edit"><i class="layui-icon layui-icon-edit"></i>编辑</a>
						<a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del"><i class="layui-icon layui-icon-delete"></i>删除</a>
					</script>
					<table id="major-list" lay-filter="major-list"></table>
				</div>
				<div class="layui-card-body" style="width:800px;">
					<div style="padding-bottom: 10px;">
						<div align="center">
							<button class="layui-btn layui-btn-normal" lay-submit lay-filter="col_task_form" id="form-submit">确认</button>
						</div>
					</div>
				</div>
			</div>
		 

		<script src="../../layuiadmin/layui/layui.js"></script>
		<script src="../util/Constants.js"></script>
		<script>
			layui.config({
				base: '../../layuiadmin/' //静态资源所在路径
			}).extend({
				index: 'lib/index' //主入口模块
			}).use(['index', 'contlist', 'table', 'laydate', 'form', 'transfer', 'numinput', 'admin'], function() {
				var $ = layui.$,
				table = layui.table,
				form = layui.form,
				admin = layui.admin,
				numinp = layui.numinput,
				laydate = layui.laydate,
				transfer = layui.transfer,
				projectBase = Class.getURL();
			
			numinp.init({
				    // 123：123键置顶, 789：789键置顶
				    topBtns: 123,
				    // 右侧功能按钮
				    rightBtns: false,
				    // 监听键盘事件
				    listening: false,
				    // 批量配置默认小数精确度
				    defaultPrec: '0'
				  });
			
			
				var data0, schoolTable;
				

				laydate.render({
					elem: '#startDate'
				});

				laydate.render({
					elem: '#endDate'
				});

				form.render();

				layui.data('choseMajor', null);

				/*var itemTable = table.render({
					elem: '#forms',
					width: 615,
					data: [{
							"col_content": "专业基本情况"
						}, {
							"col_content": "绩效目标完成情况"
						}, {
							"col_content": "资金支出进度"
						}]
						//toolbar:'#toolbarDemo'
						, 
					page: false //开启分页
						,
					cols: [
						[ //表头
							{
								type: 'numbers',
								title: '编号',
								align: 'center',
								width: 80
							}, {
								field: 'col_content',
								title: '填报内容',
								width: 350,
								align: 'center'
							}, {
								field: 'weight',
								title: '权重',
								width: 180,
								templet: '#weight',
								align: 'center'
							}
						]
					]
				});*/

				schoolTable = table.render({
					elem: '#LAY-app-content-list',
					width: 800,
					height: 320,
					data: []
						//toolbar:'#toolbarDemo'
						,
					page: true //开启分页
						,
					cols: [
						[ //表头
							{
								type: 'checkbox'
							}, {
								field: 'school_code',
								title: '院校代码',
								align: 'center',
								width: 185
							}, {
								field: 'school_name',
								title: '院校名称',
								align: 'center',
								width: 330
							}, {
								title: '操作',
								toolbar: '#table-content-list',
								align: 'center' 
							}
						]
					]
				});

				table.render({
					elem: '#major-list',
					width: 800,
					height: 320,
					data: []
						//toolbar:'#toolbarDemo'
						,
					page: true //开启分页
						,
					cols: [
						[ //表头
							{
								field: 'school_code',
								title: '院校代码',
								align: 'center' 
							}, {
								field: 'school_name',
								title: '院校名称',
								align: 'center' 
							},{
								field: 'major_code',
								title: '专业代码',
								align: 'center'
							}, {
								field: 'major_name',
								title: '专业名称',
								align: 'center'
							}
						]
					]
				});

				//监听搜索
				form.on('submit(col_task_form)', function(data) {

					var choseM = layui.data('choseMajor');

					
					var task={};
					var test1 = $('#startDate').val();
					var test2 = $('#endDate').val();
					
					var total = parseInt($('#weighting1').val()) + parseInt($('#weighting2').val()) + parseInt($('#weighting3').val());
					console.log(total);
					if( total != 100){
						layer.msg('权重相加不等于100!', function(){
						  //layer.msg('权重相加不等于100!');
						});
						return ;
					}
 
					task={
						'name':$('#name').val(),
						'year':$('#year').val(),
						'startDate':test1,
						'endDate':test2,
						'weighting1': parseInt($('#weighting1').val()),
						'weighting2': parseInt($('#weighting2').val()),
						 'weighting3': parseInt($('#weighting3').val()), 
						'schoolChose':JSON.stringify(schoolTable.config.data),
						'majorChose':JSON.stringify(choseM)
						};

					
					$.ajax({
						url: projectBase + '/collection/createTask',
						dataType: 'json',
						data: task,
						type: 'POST',
						async: false,
						success: function(res){
							//data0 = JSON.parse(res.data);
							/*if(res.code==1){*/
								
								setTimeout(function(){
									//console.log(parent.layui.admin.events);
									//parent.index.refreshAndCloseTabs();
									parent.layui.admin.events.refresh();
									parent.layui.admin.events.closeThisTabs();
									},1200);
								layer.msg("填报任务创建成功!");
							/*} else {
								layer.msg('创建填报任务时出错!',function(){ 
									
								});
							}*/
						} 
					});
					
					
				});

				//监听行单击事件（单击事件为：rowDouble）
				/* table.on('row(LAY-app-content-list)', function(obj) {
					var data = obj.data;
		
					var choseM = layui.data('choseMajor');
					console.log(choseM[data.id]);

					
					table.render({
						elem: '#major-list',
						width: 800,
						height: 320,
						data: choseM[data.id]
							//toolbar:'#toolbarDemo'
							,
						page: true //开启分页
							,
						cols: [
							[ //表头
								{
									 
									title: '院校代码',
									align: 'center',
									templet: function(d) {								    	 
										return data.school_code;							  
									}
								}, {
									title: '院校名称',
									align: 'center',
									templet: function(d) {								    	 
										return data.school_name;							  
									} 
								},{
									field: 'major_code',
									title: '专业代码',
									align: 'center'
								}, {
									field: 'major_name',
									title: '专业名称',
									align: 'center' 
								}
							]
						]
					});

					//标注选中样式
					//obj.tr.addClass('layui-table-click').siblings().removeClass('layui-table-click');
				}); */

				table.on('tool(LAY-app-content-list)', function(obj) {
					var data = obj.data;
					if (obj.event === 'edit') {
						layer.open({
							type: 2 //此处以iframe举例
								,
							title: '选择专业',
							area: ['660px', '500px'],
							//shade: 0,
							maxmin: true,
							/* offset: [ //为了演示，随机坐标
								$(window).height() - 520, $(window).width() - 1000
							], */
							btn: ['确认', '取消'],
							yes: function(index, layero) {
								//点击确认触发 iframe 内容中的按钮提交
								var submit = layero.find('iframe').contents().find("#layuiadmin-app-form-submit");
								submit.click();
								var choseMajor = layero.find('iframe').contents().find('#choseId');
								var data0 = JSON.parse(choseMajor.val());
						
								//alert(layui.data('choseMajor'));
								var choseM = layui.data('choseMajor');
								console.log(data.id);
								console.log(choseM);
								
								//layui.data('choseMajor', null);
								//var cate = layui.data('cate');
								//console.log(cate.data)
								//test1 = choseM.value;
								//alert(test1.key);

								table.render({ 
									elem: '#major-list',
									width: 800,
									height: 320,
									data: choseM[data.id]
										//toolbar:'#toolbarDemo'
										,
									page: true //开启分页
										,
									cols: [
										[ //表头
											{
												 
												title: '院校代码',
												align: 'center',
												templet: function(d) {								    	 
													return data.school_code;							  
												}
											}, {
												title: '院校名称',
												align: 'center',
												templet: function(d) {								    	 
													return data.school_name;							  
												} 
											},{
												field: 'major_code',
												title: '专业代码',
												align: 'center'
											}, {
												field: 'major_name',
												title: '专业名称',
												align: 'center'
											}
										]
									]
								});
							},
							content: 'choose_major.html',
							zIndex: layer.zIndex //重点1
								,
							success: function(layero, index) {
								var school_id = layero.find('iframe').contents().find("#school_id");
								$(school_id).val(data.id);
								layer.setTop(layero); //重点2
							}
						});

					}else if(obj.event === 'view'){
						
						var choseM = layui.data('choseMajor');
						console.log(choseM[data.id]);

						
						table.render({
							elem: '#major-list',
							width: 800,
							height: 320,
							data: choseM[data.id]
								//toolbar:'#toolbarDemo'
								,
							page: true //开启分页
								,
							cols: [
								[ //表头
									{
										 
										title: '院校代码',
										align: 'center',
										templet: function(d) {								    	 
											return data.school_code;							  
										}
									}, {
										title: '院校名称',
										align: 'center',
										templet: function(d) {								    	 
											return data.school_name;							  
										} 
									},{
										field: 'major_code',
										title: '专业代码',
										align: 'center'
									}, {
										field: 'major_name',
										title: '专业名称',
										align: 'center' 
									}
								]
							]
						});

					}
				});

				var $ = layui.$,
					active = {
						batchdel: function() {
							var checkStatus = table.checkStatus('LAY-app-content-list'),
								checkData = checkStatus.data; //得到选中的数据

							if (checkData.length === 0) {
								return layer.msg('请选择数据');
							}

							layer.confirm('确定删除吗？', function(index) {

								//执行 Ajax 后重载
								/*
								admin.req({
								  url: 'xxx'
								  //,……
								});
								*/
								table.reload('LAY-app-content-list');
								layer.msg('已删除');
							});
						},
						add: function() {
							layer.open({
								type: 2 //此处以iframe举例
									,
								title: '选择院校',
								area: ['660px', '500px'],
								//shade: 0,
								maxmin: true,
								/* offset: [ //为了演示，随机坐标
									$(window).height() - 520, $(window).width() - 1000
								], */
								btn: ['确认', '取消'],
								yes: function(index, layero) {
									//点击确认触发 iframe 内容中的按钮提交
									var submit = layero.find('iframe').contents().find("#layuiadmin-app-form-submit");
									submit.click();
									var choseSchool = layero.find('iframe').contents().find('#choseId');
									var data0 = JSON.parse(choseSchool.val());

									schoolTable = table.render({
										elem: '#LAY-app-content-list',
										width: 800,
										height: 320,
										data: data0
											//toolbar:'#toolbarDemo'
											,
										page: true //开启分页
											,
										cols: [
											[ //表头
												{
													type: 'checkbox'
												}, {
													field: 'school_code',
													title: '院校代码',
													align: 'center',
													width: 185
												}, {
													field: 'school_name',
													title: '院校名称',
													align: 'center',
													width: 330
												}, {
													title: '操作',
													toolbar: '#table-content-list',
													align: 'center'
												}
											]
										]
									});
								},
								content: 'choose_school.html',
								zIndex: layer.zIndex //重点1
									,
								success: function(layero, index) {
									var schools = layero.find('iframe').contents().find("#schools");
									schools.val(JSON.stringify(schoolTable.config.data));
									layer.setTop(layero); //重点2
								} 
							});
						}
					};

				$('.layui-btn.layuiadmin-btn-list').on('click', function() {
					var type = $(this).data('type');
					active[type] ? active[type].call(this) : '';
				});

			});
		</script>
	</body>
</html>
